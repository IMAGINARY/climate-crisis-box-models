function t(){return(t=Object.assign||function(t){for(var s=1;s<arguments.length;s++){var a=arguments[s];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(t[r]=a[r])}return t}).apply(this,arguments)}function s(t,s,a,r){const e=r(t,s);return t.map((s,r)=>t[r]+a*e[r])}function a(t,s,a,r){const e=t.length,o=r(t,s),n=Array(e),i=a/2,c=a/6,l=s+i;for(let s=0;s<e;s+=1)n[s]=t[s]+i*o[s];let h=r(n,l);for(let s=0;s<e;s+=1)n[s]=t[s]+i*h[s];const d=r(n,l);for(let s=0;s<e;s+=1)n[s]=t[s]+a*d[s],d[s]+=h[s];return h=r(n,s+a),t.map((s,a)=>t[a]+c*(o[a]+h[a]+2*d[a]))}class r{constructor({stocks:s,flows:e,variables:o,constants:n},i=a){this.stocks=s,this.flows=e,this.variables=o,this.constants=n,this.integrator=i,this.ensureUniqueIds(),this.idToIdx=t({},r.createIdToIdxMap(s),r.createIdToIdxMap(o),r.createIdToIdxMap(n),r.createIdToIdxMap(e))}ensureUniqueIds(){const t=[].concat(this.stocks,this.variables,this.constants,this.flows).map(t=>t.id).reduce((t,s,a,r)=>(r.lastIndexOf(s)!==a&&r.push(s),t),[]);if(t.length>0)throw new Error(`Duplicate ids found: ${t}`)}static createIdToIdxMap(t){const s={};return t.forEach(({id:t},a)=>s[t]=a),s}evaluateGraph(t,s){const a=s=>t[this.idToIdx[s]],r=this.constants.map(({value:t})=>t),e=t=>r[this.idToIdx[t]],o=t=>{const r=new Array(t.length);return{evaluator:o=>{const i=this.idToIdx[o];if(null===r[i])throw new Error("Evaluation cycle detected starting at: ${id}");return void 0===r[i]&&(r[i]=null,r[i]=t[i].equation(a,c,n,e,s)),r[i]},data:r}},{evaluator:n,data:i}=o(this.variables),{evaluator:c,data:l}=o(this.flows);return this.variables.forEach(({id:t})=>n(t)),this.flows.forEach(({id:t})=>c(t)),{stocks:t,flows:l,variables:i,constants:r}}step(t,s,a){return this.stepExt(t,s,a).stocks}stepExt(t,s,a){const r=this.integrator(t,s,a,(t,s)=>{const{flows:a}=this.evaluateGraph(t,s),r=t=>a[this.idToIdx[t]],e=t=>t.map(t=>r(t)).reduce((t,s)=>t+s,0);return t.map((t,s)=>e(this.stocks[s].in)-e(this.stocks[s].out))}),{flows:e,variables:o,constants:n}=this.evaluateGraph(r,s+a);return{stocks:r,variables:o,constants:n,flows:e}}}export{r as BoxModel,s as euler,a as rk4};
//# sourceMappingURL=box-model.modern.js.map
